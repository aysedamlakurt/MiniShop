<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>MiniShop - Full Debug Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .tab-content { padding: 20px; background: white; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 5px 5px; }
        .product-card { transition: 0.2s; border: 1px solid #eee; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-delete { color: crimson; cursor: pointer; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">üõí MiniShop - Debug & Kontrol Paneli</h2>

    <div id="userStatus" class="alert alert-warning d-flex justify-content-between align-items-center">
        <span>Giri≈ü yapƒ±lmadƒ±. (Sipari≈ü i√ßin giri≈ü yapmalƒ±sƒ±n)</span>
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger d-none" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#shop-tab">üõçÔ∏è Alƒ±≈üveri≈ü</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-tab">üë§ Profil / Giri≈ü</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-tab">üîß Y√∂netim (Admin)</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#orders-tab">üì¶ Sipari≈üler</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="shop-tab">
            <div class="row">
                <div class="col-md-3">
                    <h5>Kategoriler</h5>
                    <div class="list-group" id="categoryFilterList">
                        </div>
                </div>
                <div class="col-md-6">
                    <h5>√úr√ºnler</h5>
                    <div class="row g-2" id="productsList">
                        </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-success text-white">Sepetim</div>
                        <div class="card-body">
                            <ul id="cartList" class="list-unstyled">
                                <li>Sepet bo≈ü</li>
                            </ul>
                            <hr>
                            <strong>Toplam: <span id="cartTotal">0</span> ‚Ç∫</strong>
                            <button class="btn btn-primary w-100 mt-3" onclick="createOrder()">Sipari≈ü Ver</button>
                            <small id="orderResult" class="d-block mt-2"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="profile-tab">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Giri≈ü Yap (Login)</h5>
                        <input id="loginEmail" type="text" placeholder="Email" class="form-control mb-2" value="test@test.com">
                        <input id="loginPass" type="password" placeholder="≈ûifre" class="form-control mb-2" value="123456">
                        <button class="btn btn-primary w-100" onclick="login()">Giri≈ü</button>
                        <div id="loginMsg" class="mt-2 text-danger"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Kayƒ±t Ol (Register)</h5>
                        <input id="regName" type="text" placeholder="Ad Soyad" class="form-control mb-2">
                        <input id="regEmail" type="text" placeholder="Email" class="form-control mb-2">
                        <input id="regPass" type="password" placeholder="≈ûifre" class="form-control mb-2">
                        <button class="btn btn-success w-100" onclick="register()">Kayƒ±t Ol</button>
                        <div id="regMsg" class="mt-2"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>≈ûifre Deƒüi≈ütir</h5>
                        <input id="chOldPass" type="password" placeholder="Eski ≈ûifre" class="form-control mb-2">
                        <input id="chNewPass" type="password" placeholder="Yeni ≈ûifre" class="form-control mb-2">
                        <button class="btn btn-warning w-100" onclick="changePassword()">Deƒüi≈ütir</button>
                        <div id="chMsg" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="admin-tab">
            <div class="row">
                <div class="col-md-5">
                    <div class="card p-3 mb-3">
                        <h6>Kategori Ekle</h6>
                        <div class="input-group">
                            <input id="newCatName" type="text" class="form-control" placeholder="Kategori Adƒ±">
                            <button class="btn btn-primary" onclick="addCategory()">Ekle</button>
                        </div>
                    </div>
                    <h6>Kategori Listesi & Sil</h6>
                    <ul class="list-group" id="adminCatList"></ul>
                </div>

                <div class="col-md-7">
                    <div class="card p-3 mb-3">
                        <h6>√úr√ºn Ekle</h6>
                        <div class="row g-2">
                            <div class="col-6"><input id="newProdName" class="form-control" placeholder="√úr√ºn Adƒ±"></div>
                            <div class="col-6"><input id="newProdPrice" class="form-control" placeholder="Fiyat (Sayƒ±)"></div>
                            <div class="col-12"><input id="newProdDesc" class="form-control" placeholder="A√ßƒ±klama"></div>
                            <div class="col-6"><input id="newProdStock" class="form-control" placeholder="Stok"></div>
                            <div class="col-6">
                                <select id="newProdCatId" class="form-select"></select>
                            </div>
                            <div class="col-12"><button class="btn btn-primary w-100" onclick="addProduct()">√úr√ºn Ekle</button></div>
                        </div>
                    </div>
                    <h6>√úr√ºn Listesi & Sil</h6>
                    <table class="table table-sm table-bordered">
                        <thead><tr><th>ID</th><th>Ad</th><th>Stok</th><th>ƒ∞≈ülem</th></tr></thead>
                        <tbody id="adminProdList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="orders-tab">
            <button class="btn btn-secondary mb-3" onclick="loadOrders()">Listeyi Yenile</button>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Sipari≈ü No</th>
                            <th>M√º≈üteri</th>
                            <th>Tarih</th>
                            <th>Tutar</th>
                            <th>ƒ∞√ßerik</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:5147/api";
    
    // Uygulama Durumu (State)
    let currentUser = null; // { id, name, email }
    let products = [];
    let categories = [];
    let cart = [];

    // ================= YARDIMCI METOD =================
    async function req(endpoint, method = "GET", body = null) {
        const options = { method, headers: { "Content-Type": "application/json" } };
        if (body) options.body = JSON.stringify(body);
        
        try {
            const res = await fetch(`${API}/${endpoint}`, options);
            if (!res.ok) {
                const err = await res.json();
                throw err.error || err.message || JSON.stringify(err);
            }
            // Yanƒ±t bo≈ü olabilir (Delete vs)
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        } catch (e) {
            console.error("API Error:", e);
            throw e;
        }
    }

    // ================= BA≈ûLANGI√á =================
    init();
    async function init() {
        await loadCategories();
        await loadProducts();
        checkLoginStatus();
    }

    function checkLoginStatus() {
        const el = document.getElementById("userStatus");
        const btn = document.getElementById("logoutBtn");
        if (currentUser) {
            el.className = "alert alert-success d-flex justify-content-between align-items-center";
            el.innerHTML = `<span>Ho≈ügeldin, <b>${currentUser.name}</b> (ID: ${currentUser.id})</span>`;
            el.appendChild(btn);
            btn.classList.remove("d-none");
        } else {
            el.className = "alert alert-warning d-flex justify-content-between align-items-center";
            el.innerHTML = `<span>Giri≈ü yapƒ±lmadƒ±. (Sipari≈ü i√ßin Profil sekmesinden giri≈ü yapƒ±n)</span>`;
        }
    }

    function logout() {
        currentUser = null;
        cart = [];
        renderCart();
        checkLoginStatus();
    }

    // ================= VERƒ∞ Y√úKLEME =================
    async function loadCategories() {
        categories = await req("Categories");
        
        // 1. Alƒ±≈üveri≈ü Filtresi
        const filterList = document.getElementById("categoryFilterList");
        filterList.innerHTML = `<a href="#" class="list-group-item list-group-item-action active" onclick="filterProducts(null, this)">T√ºm√º</a>`;
        
        // 2. Admin Listesi
        const adminList = document.getElementById("adminCatList");
        adminList.innerHTML = "";

        // 3. √úr√ºn Ekleme Select
        const select = document.getElementById("newProdCatId");
        select.innerHTML = `<option value="">Kategori Se√ß...</option>`;

        categories.forEach(c => {
            // Filtre
            filterList.innerHTML += `<a href="#" class="list-group-item list-group-item-action" onclick="filterProducts(${c.id}, this)">${c.name}</a>`;
            
            // Admin Liste
            adminList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${c.name} (ID: ${c.id})
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${c.id})">Sil</button>
                </li>`;
            
            // Select
            select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }

    async function loadProducts() {
        products = await req("Products");
        renderProducts(products);
        renderAdminProducts(products);
    }

    function renderProducts(list) {
        const container = document.getElementById("productsList");
        container.innerHTML = "";
        list.forEach(p => {
            container.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="card product-card h-100 p-2">
                        <h6>${p.name}</h6>
                        <small class="text-muted">${p.categoryName || '-'}</small>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="fw-bold">${p.price} ‚Ç∫</span>
                            <button class="btn btn-sm btn-primary" onclick="addToCart(${p.id})">+</button>
                        </div>
                        <small>Stok: ${p.stock}</small>
                    </div>
                </div>`;
        });
    }

    function renderAdminProducts(list) {
        const tbody = document.getElementById("adminProdList");
        tbody.innerHTML = "";
        list.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.stock}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">X</button></td>
                </tr>`;
        });
    }

    function filterProducts(catId, el) {
        // UI Aktif Sƒ±nƒ±fƒ±
        document.querySelectorAll("#categoryFilterList a").forEach(a => a.classList.remove("active"));
        el.classList.add("active");

        if (!catId) {
            renderProducts(products);
        } else {
            renderProducts(products.filter(p => p.categoryId === catId));
        }
    }

    // ================= AUTH (AUTH CONTROLLER) =================
    async function login() {
        const email = document.getElementById("loginEmail").value;
        const pass = document.getElementById("loginPass").value;
        const msg = document.getElementById("loginMsg");
        
        try {
            const res = await req("Auth/login", "POST", { email, password: pass });
            currentUser = res.customer; // Backend 'customer' objesi d√∂n√ºyor
            msg.textContent = "";
            checkLoginStatus();
            alert("Giri≈ü Ba≈üarƒ±lƒ±!");
        } catch (err) {
            msg.textContent = err;
        }
    }

    async function register() {
        const body = {
            name: document.getElementById("regName").value,
            email: document.getElementById("regEmail").value,
            password: document.getElementById("regPass").value
        };
        const msg = document.getElementById("regMsg");
        try {
            const res = await req("Auth/register", "POST", body); // AuthController
            msg.className = "text-success";
            msg.textContent = "Kayƒ±t ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapabilirsin.";
        } catch (err) {
            msg.className = "text-danger";
            msg.textContent = JSON.stringify(err);
        }
    }

    async function changePassword() {
        if (!currentUser) return alert("√ñnce giri≈ü yapmalƒ±sƒ±n!");
        const body = {
            customerId: currentUser.id,
            oldPassword: document.getElementById("chOldPass").value,
            newPassword: document.getElementById("chNewPass").value,
            newPasswordConfirm: document.getElementById("chNewPass").value // Basitlik i√ßin
        };
        try {
            await req("Auth/change-password", "POST", body);
            document.getElementById("chMsg").className = "text-success";
            document.getElementById("chMsg").textContent = "≈ûifre deƒüi≈üti.";
        } catch (err) {
            document.getElementById("chMsg").className = "text-danger";
            document.getElementById("chMsg").textContent = JSON.stringify(err);
        }
    }

    // ================= SEPET & Sƒ∞PARƒ∞≈û =================
    function addToCart(id) {
        const prod = products.find(p => p.id === id);
        const item = cart.find(c => c.product.id === id);
        if (item) item.adet++;
        else cart.push({ product: prod, adet: 1 });
        renderCart();
    }

    function renderCart() {
        const ul = document.getElementById("cartList");
        const totalSpan = document.getElementById("cartTotal");
        ul.innerHTML = "";
        let total = 0;

        cart.forEach(c => {
            total += c.product.price * c.adet;
            ul.innerHTML += `<li>${c.product.name} x ${c.adet}</li>`;
        });

        if (cart.length === 0) ul.innerHTML = "<li>Sepet bo≈ü</li>";
        totalSpan.textContent = total;
    }

    async function createOrder() {
        if (!currentUser) return alert("L√ºtfen √∂nce Profil sekmesinden giri≈ü yapƒ±n!");
        if (cart.length === 0) return alert("Sepet bo≈ü!");

        const body = {
            customerId: currentUser.id,
            items: cart.map(c => ({ productId: c.product.id, adet: c.adet }))
        };

        const msg = document.getElementById("orderResult");
        try {
            const res = await req("Orders/create", "POST", body);
            msg.className = "text-success";
            msg.textContent = typeof res === 'string' ? res : res.message || "Sipari≈ü alƒ±ndƒ±!";
            cart = [];
            renderCart();
            loadProducts(); // Stoklar d√º≈üt√ºƒü√º i√ßin yenile
        } catch (err) {
            msg.className = "text-danger";
            msg.textContent = "Hata: " + JSON.stringify(err);
        }
    }

    // ================= Sƒ∞PARƒ∞≈ûLERƒ∞ Lƒ∞STELE =================
    async function loadOrders() {
        try {
            const orders = await req("Orders");
            const tbody = document.getElementById("ordersTableBody");
            tbody.innerHTML = "";
            orders.forEach(o => {
                const itemsHtml = o.items.map(i => `${i.productName} (${i.adet})`).join(", ");
                tbody.innerHTML += `
                    <tr>
                        <td>${o.id}</td>
                        <td>${o.customerName}</td>
                        <td>${new Date(o.orderDate).toLocaleString()}</td>
                        <td>${o.totalAmount} ‚Ç∫</td>
                        <td><small>${itemsHtml}</small></td>
                    </tr>`;
            });
        } catch (err) {
            alert("Sipari≈üler √ßekilemedi: " + err);
        }
    }

    // ================= ADMIN (EKLE / Sƒ∞L) =================
    async function addCategory() {
        const name = document.getElementById("newCatName").value;
        try {
            await req("Categories", "POST", { name });
            document.getElementById("newCatName").value = "";
            loadCategories();
        } catch(e) { alert(e); }
    }

    async function deleteCategory(id) {
        if(!confirm("Emin misin?")) return;
        try { await req(`Categories/${id}`, "DELETE"); loadCategories(); }
        catch(e) { alert(e); }
    }

    async function addProduct() {
        const body = {
            name: document.getElementById("newProdName").value,
            price: parseFloat(document.getElementById("newProdPrice").value),
            description: document.getElementById("newProdDesc").value,
            stock: parseInt(document.getElementById("newProdStock").value),
            categoryId: parseInt(document.getElementById("newProdCatId").value)
        };
        try {
            await req("Products", "POST", body);
            alert("√úr√ºn eklendi");
            loadProducts();
        } catch(e) { alert(e); }
    }

    async function deleteProduct(id) {
        if(!confirm("Silinecek?")) return;
        try { await req(`Products/${id}`, "DELETE"); loadProducts(); }
        catch(e) { alert(e); }
    }

</script>
</body>
</html>